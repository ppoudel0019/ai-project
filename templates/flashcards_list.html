<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Manage Flashcards</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    .toolbar{max-width:900px;margin:1rem auto;display:flex;justify-content:space-between;align-items:center;color:#fff}
    .stack{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{border:none;border-radius:8px;padding:.5rem .9rem;cursor:pointer}
    .ghost{background:#fff;border:1px solid #ddd}
    .primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    .danger{background:#ef5350;color:#fff}
    .muted{opacity:.75;font-size:.9rem}

    .card{max-width:900px;margin:1rem auto;background:#fff;padding:1.2rem;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .grid-head,.grid-row{
      display:grid;grid-template-columns:1fr 1fr .6fr .6fr .9fr;gap:12px;align-items:start
    }
    .grid-head{font-weight:600;border-bottom:1px solid #eee;padding:.5rem 0;color:#555}
    .grid-row{padding:.6rem 0;border-bottom:1px solid #f1f1f1}
    .grid-row:last-child{border-bottom:none}
    .badge{padding:.15rem .45rem;border:1px solid #ddd;border-radius:6px}
    input,select{width:100%;padding:.55rem;border:1px solid #e0e0e0;border-radius:8px}

    /* Toasts (local only) */
    #toast-container{
      position:fixed;top:20px;right:20px;z-index:9999;
      display:flex;flex-direction:column;gap:10px
    }

    /* Confirm modal (local only) */
    .cfm-modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:300}
    .cfm-modal.open{display:flex}
    .cfm-panel{width:min(520px,92vw);background:#fff;border-radius:12px;box-shadow:0 12px 32px rgba(0,0,0,.25);padding:16px 18px}
    .cfm-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .cfm-title{font-size:1.05rem;font-weight:700}
    .cfm-close{border:0;background:transparent;font-size:1.2rem;cursor:pointer}
    .cfm-body{color:#333;line-height:1.45}
    .cfm-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
    .btn-ghost{background:#fafafa}
    .btn-danger{background:#ef5350;color:#fff}
  </style>
</head>
<body>
  <!-- Toast container -->
  <div id="toast-container"></div>

  <!-- Confirm Modal -->
  <div id="confirmModal" class="cfm-modal" aria-hidden="true" role="dialog" aria-labelledby="cfmTitle">
    <div class="cfm-panel">
      <div class="cfm-header">
        <div id="cfmTitle" class="cfm-title">Confirm</div>
        <button id="cfmClose" class="cfm-close" title="Close">‚úï</button>
      </div>
      <div id="cfmMessage" class="cfm-body">Are you sure?</div>
      <div class="cfm-actions">
        <button id="cfmCancel" class="btn btn-ghost" type="button">Cancel</button>
        <button id="cfmConfirm" class="btn btn-danger" type="button">Delete</button>
      </div>
    </div>
  </div>

  <div class="container">

    <!-- Top toolbar -->
    <div class="toolbar">
      <div class="stack">
        <a class="ghost btn" href="{{ url_for('chat.subjects') }}">Subjects</a>
        <a class="ghost btn" href="{{ url_for('flashcards.list_cards', subject=subject) }}">Manage Flashcards</a>
        <a class="ghost btn" href="{{ url_for('flashcards.review_queue', subject=subject) }}">Review</a>
        <a class="ghost btn" href="{{ url_for('flashcards.review_queue', subject=subject, replay=1) }}">Replay</a>
      </div>

      <form method="get" action="{{ url_for('flashcards.list_cards') }}" class="stack">
        <label class="muted" for="subj">Filter:</label>
        <select id="subj" name="subject" onchange="this.form.submit()">
          <option value="">All subjects</option>
          {% for s in subjects %}
            <option value="{{ s }}" {{ 'selected' if subject==s else '' }}>{{ s|capitalize }}</option>
          {% endfor %}
        </select>
      </form>
    </div>

    <!-- Create -->
    <div class="card">
      <h2 style="margin-top:0">Manage Flashcards</h2>
      <form id="newCardForm">
        <h3>Create a New Flashcard</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr .6fr;gap:12px">
          <input name="front" placeholder="Question" required>
          <input name="back" placeholder="Answer" required>
          <select name="subject">
            <option value="">general</option>
            {% for s in subjects %}
              <option value="{{ s }}" {{ 'selected' if s==subject else '' }}>{{ s|capitalize }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="margin-top:.75rem;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn primary" type="submit">Save</button>
        </div>
      </form>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="grid-head">
        <div>Question</div><div>Answer</div><div>Subject</div><div>Due</div><div>Actions</div>
      </div>

      {% for c in cards %}
        <div class="grid-row" id="card-{{ c.id }}">
          <div>{{ c.front }}</div>
          <div>{{ c.back }}</div>
          <div><span class="badge muted">{{ (c.subject or 'general')|capitalize }}</span></div>
          <div class="muted">{{ c.due_at.strftime('%Y-%m-%d') }}</div>
          <div class="stack">
            <a class="ghost btn" href="{{ url_for('flashcards.review_queue', subject=c.subject) }}">Review</a>
            <button class="btn danger" type="button" onclick="confirmDelete({{ c.id }})">Delete</button>
          </div>
        </div>
      {% else %}
        <p class="muted" style="padding:.75rem 0 0">No flashcards yet. Create one above or from chat answers.</p>
      {% endfor %}
    </div>
  </div>

  <script>
    /* ---------- Toast helper ---------- */
    function showToast(message, type='info'){
      const container=document.getElementById('toast-container');
      const el=document.createElement('div');
      el.textContent=message;
      el.style.cssText=`
        background:${type==='error'?'#ff3b30':type==='success'?'#34c759':'#333'};
        color:#fff;padding:10px 16px;border-radius:8px;font-size:.9rem;
        box-shadow:0 4px 10px rgba(0,0,0,.15);opacity:0;transform:translateY(-10px);
        transition:all .4s ease;
      `;
      container.appendChild(el);
      requestAnimationFrame(()=>{ el.style.opacity='1'; el.style.transform='translateY(0)'; });
      setTimeout(()=>{ el.style.opacity='0'; el.style.transform='translateY(-10px)'; setTimeout(()=>el.remove(), 400); }, 2500);
    }

    /* ---------- Confirm modal helpers ---------- */
    const cfm = document.getElementById('confirmModal');
    const cfmTitle = document.getElementById('cfmTitle');
    const cfmMessage = document.getElementById('cfmMessage');
    const cfmConfirm = document.getElementById('cfmConfirm');
    const cfmCancel = document.getElementById('cfmCancel');
    const cfmClose = document.getElementById('cfmClose');

    let _confirmResolve = null;

    function openConfirm({title='Confirm', message='Are you sure?', confirmText='Delete'} = {}){
      cfmTitle.textContent = title;
      cfmMessage.textContent = message;
      cfmConfirm.textContent = confirmText;

      cfm.classList.add('open');
      cfm.setAttribute('aria-hidden','false');

      return new Promise(resolve => {
        _confirmResolve = resolve;
      });
    }
    function closeConfirm(result=false){
      cfm.classList.remove('open');
      cfm.setAttribute('aria-hidden','true');
      if (_confirmResolve){ _confirmResolve(result); _confirmResolve=null; }
    }

    // wire interactions
    cfmCancel.addEventListener('click', ()=>closeConfirm(false));
    cfmClose.addEventListener('click', ()=>closeConfirm(false));
    cfm.addEventListener('click', (e)=>{ if(e.target===cfm) closeConfirm(false); });
    cfm.addEventListener('keydown', (e)=>{
      if (e.key==='Escape'){ e.preventDefault(); closeConfirm(false); }
      if (e.key==='Enter'){ e.preventDefault(); closeConfirm(true); }
    });
    cfmConfirm.addEventListener('click', ()=>closeConfirm(true));

    /* ---------- Create ---------- */
    document.getElementById('newCardForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());
      try {
        const r = await fetch('{{ url_for("flashcards.create_card") }}', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(r.ok){
          showToast('‚úÖ Flashcard created!', 'success');
          setTimeout(()=>location.reload(), 400); // refresh to show new row
        } else {
          showToast('Failed to create flashcard', 'error');
        }
      } catch (err) {
        showToast('Network error creating flashcard', 'error');
      }
    });

    /* ---------- Delete with custom confirm ---------- */
    async function confirmDelete(card_id){
      // Open modal
      const yes = await openConfirm({
        title: 'Delete flashcard',
        message: 'This action cannot be undone. Do you want to permanently delete this flashcard?',
        confirmText: 'Delete'
      });
      if (!yes) return;

      // Proceed with deletion
      try {
        const r = await fetch('{{ url_for("flashcards.delete_card") }}', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({card_id})
        });
        if(r.ok){
          const row = document.getElementById('card-'+card_id);
          if(row) row.remove();
          showToast('üóëÔ∏è Flashcard deleted', 'success');
        } else {
          showToast('Failed to delete flashcard', 'error');
        }
      } catch (err) {
        showToast('Network error deleting flashcard', 'error');
      }
    }

    // Accessibility: allow keyboard focus inside modal when opened
    // (optional, keeps simple by not trapping focus)
  </script>
</body>
</html>
