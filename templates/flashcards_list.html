<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Manage Flashcards</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    .toolbar{max-width:900px;margin:1rem auto;display:flex;justify-content:space-between;align-items:center;color:#fff}
    .stack{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{border:none;border-radius:8px;padding:.5rem .9rem;cursor:pointer}
    .ghost{background:#fff;border:1px solid #ddd}
    .primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    .danger{background:#ef5350;color:#fff}
    .muted{opacity:.75;font-size:.9rem}

    .card{max-width:900px;margin:1rem auto;background:#fff;padding:1.2rem;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .grid-head,.grid-row{
      display:grid;grid-template-columns:1fr 1fr .6fr .6fr .9fr;gap:12px;align-items:start
    }
    .grid-head{font-weight:600;border-bottom:1px solid #eee;padding:.5rem 0;color:#555}
    .grid-row{padding:.6rem 0;border-bottom:1px solid #f1f1f1}
    .grid-row:last-child{border-bottom:none}
    .badge{padding:.15rem .45rem;border:1px solid #ddd;border-radius:6px}
    input,select{width:100%;padding:.55rem;border:1px solid #e0e0e0;border-radius:8px}
  </style>
</head>
<body>
  <div class="container">

    <!-- Top toolbar -->
    <div class="toolbar">
      <div class="stack">
        <a class="ghost btn" href="{{ url_for('chat.subjects') }}">Subjects</a>
        <a class="ghost btn" href="{{ url_for('flashcards.list_cards', subject=subject) }}">Manage Flashcards</a>
        <a class="ghost btn" href="{{ url_for('flashcards.review_queue', subject=subject) }}">Review</a>
        <a class="ghost btn" href="{{ url_for('flashcards.review_queue', subject=subject, replay=1) }}">Replay</a>
      </div>

      <form method="get" action="{{ url_for('flashcards.list_cards') }}" class="stack">
        <label class="muted" for="subj">Filter:</label>
        <select id="subj" name="subject" onchange="this.form.submit()">
          <option value="">All subjects</option>
          {% for s in subjects %}
            <option value="{{ s }}" {{ 'selected' if subject==s else '' }}>{{ s|capitalize }}</option>
          {% endfor %}
        </select>
      </form>
    </div>

    <!-- Create -->
    <div class="card">
      <h2 style="margin-top:0">Manage Flashcards</h2>
      <form id="newCardForm">
        <h3>Create a New Flashcard</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr .6fr;gap:12px">
          <input name="front" placeholder="Question" required>
          <input name="back" placeholder="Answer" required>
          <select name="subject">
            <option value="">general</option>
            {% for s in subjects %}
              <option value="{{ s }}" {{ 'selected' if s==subject else '' }}>{{ s|capitalize }}</option>
            {% endfor %}
          </select>
        </div>
        <div style="margin-top:.75rem;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn primary" type="submit">Save</button>
        </div>
      </form>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="grid-head">
        <div>Question</div><div>Answer</div><div>Subject</div><div>Due</div><div>Actions</div>
      </div>

      {% for c in cards %}
        <div class="grid-row" id="card-{{ c.id }}">
          <div>{{ c.front }}</div>
          <div>{{ c.back }}</div>
          <div><span class="badge muted">{{ (c.subject or 'general')|capitalize }}</span></div>
          <div class="muted">{{ c.due_at.strftime('%Y-%m-%d') }}</div>
          <div class="stack">
            <a class="ghost btn" href="{{ url_for('flashcards.review_queue', subject=c.subject) }}">Review</a>
            <button class="btn danger" type="button" onclick="deleteCard({{ c.id }})">Delete</button>
          </div>
        </div>
      {% else %}
        <p class="muted" style="padding:.75rem 0 0">No flashcards yet. Create one above or from chat answers.</p>
      {% endfor %}
    </div>
  </div>

  <script>
    // Create
    document.getElementById('newCardForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());
      const r = await fetch('{{ url_for("flashcards.create_card") }}', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(r.ok){ location.reload(); } else { alert('Error creating flashcard'); }
    });

    // Delete
    async function deleteCard(card_id){
      if(!confirm('Delete this flashcard?')) return;
      const r = await fetch('{{ url_for("flashcards.delete_card") }}', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({card_id})
      });
      if(r.ok){
        const row = document.getElementById('card-'+card_id);
        if(row) row.remove();
      } else {
        alert('Failed to delete flashcard');
      }
    }
  </script>
</body>
</html>
