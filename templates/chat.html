<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ subject_name }} Study Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <style>
      /* ===== Local-only styles for sidebar, drawer, modal, toasts ===== */
      .sb-side {
        position: absolute;
        right: -70px;
        top: 120px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 10;
      }
      .sb-btn {
        background: #fff;
        border: 1px solid #e8e8e8;
        border-radius: 12px;
        padding: 0.6rem 0.8rem;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        width: 64px;
        font-size: 0.8rem;
        font-weight: 600;
      }
      .sb-btn:hover { background: #f8f8ff; }
      @media (max-width: 1000px) {
        .sb-side { position: static; flex-direction: row; justify-content: center; margin: 0.5rem 0; }
        .sb-btn { width: auto; }
      }

      .sb-drawer {
        position: fixed; inset: 0; background: rgba(0,0,0,0.3);
        display: none; align-items: flex-end; justify-content: flex-end; z-index: 200;
      }
      .sb-drawer.open { display: flex; }
      .sb-drawer__panel {
        width: min(520px, 92vw); height: 100vh; background: #fff;
        padding: 16px 18px; overflow: auto; box-shadow: -10px 0 30px rgba(0,0,0,0.25);
      }
      .sb-drawer__close {
        float: right; border: none; background: transparent; font-size: 1.2rem; cursor: pointer;
      }
      .sb-code { white-space: pre-wrap; background: #f7f7fb; padding: .75rem; border-radius: 8px; border: 1px solid #eee; }

      /* Markdown styling inside drawer */
      .sb-md ul { margin: .4rem 0 .6rem 1.2rem; }
      .sb-md li { margin: .2rem 0; }
      .sb-md a { color: #3b5cff; text-decoration: none; }
      .sb-md a:hover { text-decoration: underline; }
      .sb-md code { background:#f3f3f7; padding:0 .25rem; border-radius:4px; }
      .sb-md pre { background:#f7f7fb; padding:.5rem; border-radius:8px; overflow:auto; }

      /* Toasts (local) */
      #toast-container {
        position: fixed; top: 20px; right: 20px; z-index: 9999;
        display: flex; flex-direction: column; gap: 10px;
      }

      /* Flashcard modal (local) */
      .sb-modal {
        position: fixed; inset: 0; display: none; z-index: 300;
        align-items: center; justify-content: center;
        background: rgba(0,0,0,0.35);
      }
      .sb-modal.open { display: flex; }
      .sb-modal__panel {
        width: min(560px, 92vw); background: #fff; border-radius: 12px;
        box-shadow: 0 12px 32px rgba(0,0,0,0.25);
        padding: 16px 18px;
      }
      .sb-modal__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
      .sb-modal__title { font-size: 1.05rem; font-weight: 700; }
      .sb-modal__close { border: 0; background: transparent; font-size: 1.2rem; cursor: pointer; }
      .sb-field { margin: 10px 0; }
      .sb-label { display:block; font-size:.9rem; font-weight:600; margin-bottom:6px; }
      .sb-input, .sb-textarea {
        width: 100%; border: 1px solid #e6e6ea; border-radius: 8px; padding: .6rem .7rem;
        font: inherit; outline: none;
      }
      .sb-textarea { min-height: 120px; resize: vertical; }
      .sb-actions { display:flex; gap:10px; justify-content:flex-end; margin-top: 12px; }
      .sb-btn--ghost { background: #fafafa; }
      .sb-btn--primary { background:#3b5cff; color:#fff; border:1px solid #2f45f7; }
      .sb-btn--primary:hover { filter: brightness(1.05); }

      /* Keep message column to allow left-aligned tool row */
      .chat-messages {
        display: flex;
        flex-direction: column;
      }

      /* Left-aligned tiny tool row right under bot bubble (separate sibling) */
      .message-tools {
        display: inline-flex;
        gap: 6px;
        align-self: flex-start;
        margin: 4px 0 0 0;
        padding: 0;
      }
      .message + .message-tools { margin-top: 4px; }

      .icon-btn {
        border: 0;
        background: #f3f4f6;
        width: 24px;
        height: 24px;
        border-radius: 9999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
      }
      .icon-btn:hover { background: #e5e7eb; }
      .icon-btn[disabled] { opacity: .5; cursor: not-allowed; }

      /* ===== Verification containers ===== */
      .sb-block {
        border: 1px solid #eee;
        border-radius: 10px;
        padding: 10px 12px;
        margin: 10px 0;
        background: #fafbff;
      }
      .sb-block__title {
        font-weight: 700;
        margin-bottom: 6px;
      }
    </style>
  </head>

  <body>
    <!-- Toast container -->
    <div id="toast-container"></div>

    <div class="chat-container" style="position: relative;" data-subject="{{ subject }}" data-subject-name="{{ subject_name }}">
      <div class="chat-header">
        <div class="header-content">
          <a class="back-btn" onclick="window.location.href='{{ url_for('chat.subjects') }}'">&larr; Back</a>
          <h1>{{ subject_name }} Study Assistant</h1>
          <div style="display:flex;gap:8px;align-items:center;">
            <button id="resetBtn" class="reset-btn" type="button">Reset Chat</button>
            {% if current_user.is_authenticated %}
              <a class="reset-btn" href="{{ url_for('flashcards.review_queue', subject=subject) }}">Flashcards</a>
            {% endif %}
          </div>
        </div>
      </div>

      <aside class="sb-side">
        <button id="summaryBtn" class="sb-btn" title="Summarize chat">üìù Summary</button>
        <button id="quizBtn" class="sb-btn" title="Quiz me">üß™ Quiz</button>
        <button id="exportBtn" class="sb-btn" title="Export chat + summary">‚¨áÔ∏è Export</button>
      </aside>

      <div id="messages" class="chat-messages">
        <div class="message bot-message">
          <div class="message-content">
            Hi! I'm your {{ subject_name }} assistant. Ask me anything about {{ subject_name }}.
            I remember the last 4 Q&A pairs for context.
          </div>
        </div>
        <!-- tool rows will be injected as separate siblings after each bot message -->
      </div>

      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <input id="questionInput" type="text" placeholder="Ask about {{ subject_name }}..." />
          <button id="sendBtn" type="button">Send</button>
        </div>
        <div id="loading" class="loading-indicator" style="display:none;">Thinking...</div>
      </div>
    </div>

    <!-- Drawer -->
    <div id="drawer" class="sb-drawer" aria-hidden="true">
      <div class="sb-drawer__panel">
        <button id="drawerClose" class="sb-drawer__close" title="Close">‚úï</button>
        <div id="drawerContent"></div>
      </div>
    </div>

    <!-- Flashcard Modal -->
    <div id="fcModal" class="sb-modal" aria-hidden="true" role="dialog" aria-labelledby="fcTitle">
      <div class="sb-modal__panel">
        <div class="sb-modal__header">
          <div id="fcTitle" class="sb-modal__title">Create Flashcard</div>
          <button id="fcClose" class="sb-modal__close" title="Close">‚úï</button>
        </div>
        <div class="sb-field">
          <label class="sb-label" for="fcFront">Front (Question)</label>
          <input id="fcFront" class="sb-input" type="text" placeholder="e.g., What is the chain rule?" />
        </div>
        <div class="sb-field">
          <label class="sb-label" for="fcBack">Back (Answer / Notes)</label>
          <textarea id="fcBack" class="sb-textarea" placeholder="Your answer or explanation..."></textarea>
        </div>
        <div class="sb-actions">
          <button id="fcCancel" class="sb-btn sb-btn--ghost" type="button">Cancel</button>
          <button id="fcSave" class="sb-btn sb-btn--primary" type="button">Save</button>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const subject = document.querySelector('.chat-container').getAttribute('data-subject');
        const messagesEl = document.getElementById('messages');
        const inputEl = document.getElementById('questionInput');
        const sendBtn = document.getElementById('sendBtn');
        const loadingEl = document.getElementById('loading');
        const resetBtn = document.getElementById('resetBtn');
        const summaryBtn = document.getElementById('summaryBtn');
        const quizBtn = document.getElementById('quizBtn');
        const exportBtn = document.getElementById('exportBtn');
        const drawer = document.getElementById('drawer');
        const drawerContent = document.getElementById('drawerContent');
        const drawerClose = document.getElementById('drawerClose');
        const IS_GUEST = {{ 'true' if (session.get('guest') and not current_user.is_authenticated) else 'false' }};

        if (IS_GUEST) {
          const sb = document.querySelector('.sb-side');
          if (sb) sb.style.display = 'none';
        }

        /* Hoisted so listeners can use it */
        function requireAuthAction(cb) {
          return (...a) => {
            if (IS_GUEST) { alert('Please log in to use this feature.'); return; }
            cb(...a);
          };
        }

        let sessionId = sessionStorage.getItem('study_session_id');
        if (!sessionId) {
          sessionId = Math.random().toString(36).slice(2) + Date.now().toString(36);
          sessionStorage.setItem('study_session_id', sessionId);
        }

        /* Toast helper */
        function showToast(message, type = 'info') {
          const container = document.getElementById('toast-container');
          if (!container) return;
          const toast = document.createElement('div');
          toast.textContent = message;
          toast.style.cssText = `
            background: ${type === 'error' ? '#ff3b30' : type === 'success' ? '#34c759' : '#333'};
            color: white; padding: 10px 16px; border-radius: 8px;
            font-size: 0.9rem; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            opacity: 0; transform: translateY(-10px); transition: all 0.4s ease;
          `;
          container.appendChild(toast);
          requestAnimationFrame(() => { toast.style.opacity = '1'; toast.style.transform = 'translateY(0)'; });
          setTimeout(() => {
            toast.style.opacity = '0'; toast.style.transform = 'translateY(-10px)';
            setTimeout(() => toast.remove(), 400);
          }, 2500);
        }

        /* Drawer helpers */
        function openDrawer(html){
          if (IS_GUEST) { alert('Please log in to use this feature.'); return; }
          drawerContent.innerHTML = html;
          drawer.classList.add('open');
          drawer.setAttribute('aria-hidden','false');
        }
        function closeDrawer(){
          drawer.classList.remove('open');
          drawer.setAttribute('aria-hidden','true');
          drawerContent.innerHTML = '';
        }
        drawer.addEventListener('click', e => { if(e.target===drawer) closeDrawer(); });
        drawerClose.addEventListener('click', closeDrawer);

        /* Flashcard modal helpers */
        const fcModal  = document.getElementById('fcModal');
        const fcFront  = document.getElementById('fcFront');
        const fcBack   = document.getElementById('fcBack');
        const fcSave   = document.getElementById('fcSave');
        const fcCancel = document.getElementById('fcCancel');
        const fcClose  = document.getElementById('fcClose');
        let _fcResolve = null;

        function openFlashcardModal({front='', back=''} = {}) {
          if (!fcModal) return Promise.resolve(null);
          fcFront.value = front;
          fcBack.value  = back;
          fcModal.classList.add('open');
          fcModal.setAttribute('aria-hidden','false');
          setTimeout(() => (front ? fcBack : fcFront).focus(), 0);
          return new Promise(resolve => { _fcResolve = resolve; });
        }
        function closeFlashcardModal(result = null) {
          if (!fcModal) return;
          fcModal.classList.remove('open');
          fcModal.setAttribute('aria-hidden','true');
          if (_fcResolve) { _fcResolve(result); _fcResolve = null; }
        }
        if (fcModal) {
          fcCancel?.addEventListener('click', () => closeFlashcardModal(null));
          fcClose?.addEventListener('click', () => closeFlashcardModal(null));
          fcModal.addEventListener('click', (e) => { if (e.target === fcModal) closeFlashcardModal(null); });
          fcModal.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { e.preventDefault(); closeFlashcardModal(null); }
            if (e.key === 'Enter' && (document.activeElement === fcFront || document.activeElement === fcBack)) {
              e.preventDefault(); fcSave?.click();
            }
          });
          fcSave?.addEventListener('click', () => {
            const front = fcFront.value.trim();
            const back  = fcBack.value.trim();
            if (!front) { fcFront.focus(); return; }
            if (!back)  { fcBack.focus(); return; }
            closeFlashcardModal({ front, back });
          });
        }

        /* Markdown utils (unchanged) */
        function sb_escapeHtml(s){return (s||'').replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}
        function sb_renderMarkdown(md){
          if(!md) return '';
          let codeBlocks=[]; md=md.replace(/```([\s\S]*?)```/g,(_,c)=>{const i=codeBlocks.push(c)-1;return`\u0000CODE${i}\u0000`;});
          let html=sb_escapeHtml(md);
          html=html.replace(/`([^`]+)`/g,'<code>$1</code>');
          html=html.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
          html=html.replace(/\*([^*\n]+)\*/g,'<em>$1</em>');
          html=html.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>');
          html=html.replace(/(^|\n)([*+-])\s+(.+)(?=\n|$)/g,'$1<li>$3</li>');
          html=html.replace(/(?:\n<li>[\s\S]*?<\/li>)+/g,m=>`<ul>${m.replace(/\n(?=<li>)/g,'')}</ul>`);
          html=html.split(/\n{2,}/).map(bl=>/^\s*<(ul|li|pre|code|h\d)/.test(bl)?bl:`<p>${bl.replace(/\n/g,'<br>')}</p>`).join('');
          html=html.replace(/\u0000CODE(\d+)\u0000/g,(_,i)=>`<pre><code>${sb_escapeHtml(codeBlocks[+i]||'')}</code></pre>`);
          return html;
        }

        /* ================= Verify drawer: 3 clear containers ================= */
        function getPreviousUserQuestion(fromWrapper) {
          let node = fromWrapper.previousElementSibling;
          while (node) {
            if (node.classList && node.classList.contains('user-message')) {
              const mc = node.querySelector('.message-content');
              return (mc ? mc.textContent : '').trim();
            }
            node = node.previousElementSibling;
          }
          return '';
        }

        // Extract a markdown section by its H3 title into plain md (without the H3 line)
        function extractSection(md, headingPattern) {
          if (!md) return '';
          const re = new RegExp(`(?:^|\\n)###\\s*${headingPattern}\\s*\\n([\\s\\S]*?)(?=\\n###\\s|$)`, 'i');
          const m = md.match(re);
          return m ? m[1].trim() : '';
        }

        window.verifyInfo = async function(btn, msgWrap) {
          if (IS_GUEST) { alert('Please log in to verify answers.'); return; }
          const question = getPreviousUserQuestion(msgWrap);
          const answerExcerpt = msgWrap.querySelector('.message-content').textContent.trim().slice(0, 800);

          openDrawer(`<h3>Verification</h3><div class="sb-code">Fetching‚Ä¶</div>`);
          if (btn) { btn.disabled = true; btn.dataset.old = btn.innerHTML; btn.innerHTML = '‚è≥'; }
          try {
            const r = await fetch('/api/verify', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ session_id: sessionId, subject, question, answer_excerpt: answerExcerpt })
            });
            const d = await r.json();
            const rawMd = (d.reply || d.answer) || '';

            // Split server markdown into blocks
            const waMd = extractSection(rawMd, 'Wolfram\\|Alpha Answer');
            const geminiMd = extractSection(rawMd, 'Gemini Suggested Sources');

            // Build containers
            const blocks = [];

            // Assistant excerpt (markdown-rendered so inline code/links show nicely)
            blocks.push(`
              <div class="sb-block">
                <div class="sb-block__title"><strong>Assistant Answer (excerpt)</strong></div>
                <div class="sb-md">${sb_renderMarkdown(answerExcerpt)}</div>
              </div>
            `);

            if (waMd) {
              blocks.push(`
                <div class="sb-block">
                  <div class="sb-block__title"><strong>Wolfram|Alpha Answer</strong></div>
                  <div class="sb-md">${sb_renderMarkdown(waMd)}</div>
                </div>
              `);
            }

            if (geminiMd) {
              blocks.push(`
                <div class="sb-block">
                  <div class="sb-block__title"><strong>Gemini Suggested Sources</strong></div>
                  <div class="sb-md">${sb_renderMarkdown(geminiMd)}</div>
                </div>
              `);
            }

            // If server didn‚Äôt include recognizable sections, fallback to showing entire markdown once.
            if (!waMd && !geminiMd && rawMd) {
              blocks.push(`
                <div class="sb-block">
                  <div class="sb-block__title"><strong>Verification</strong></div>
                  <div class="sb-md">${sb_renderMarkdown(rawMd)}</div>
                </div>
              `);
            }

            drawerContent.innerHTML = `<h3>Verification</h3>${blocks.join('')}`;
          } catch (e) {
            openDrawer(`<h3>Verification</h3><div class="sb-code">${sb_escapeHtml(e.message)}</div>`);
          } finally {
            if (btn) { btn.disabled = false; btn.innerHTML = btn.dataset.old || '‚úÖ'; }
          }
        };

        /* ---------------- Interactive Quiz (unchanged) ---------------- */
        function sb_getCorrectIdx(q) {
          let ai = q.answer_index;
          if (ai == null) ai = q.answerIndex;
          if (ai == null) ai = q.correct;
          if (ai == null) ai = q.correct_index;
          if (ai == null) ai = q.correctIndex;
          if (ai == null) ai = q.answer;
          if (typeof ai === 'string') {
            const t = ai.trim().toUpperCase();
            const map = { A:0, B:1, C:2, D:3 };
            if (t in map) ai = map[t];
          }
          const n = Number(ai);
          return Number.isFinite(n) ? n : NaN;
        }
        function sb_normQuestion(q) {
          const correctIdx = sb_getCorrectIdx(q);
          const choices = Array.isArray(q.choices) ? q.choices.slice(0,4) : [];
          while (choices.length < 4) choices.push('‚Äî');
          return {
            question: q.question || '',
            choices,
            answer_index: correctIdx,
            rationale: q.rationale || ''
          };
        }

        let sbQuiz = null;

        function sb_renderQuizView(){
          const q = sbQuiz.questions[sbQuiz.index];
          const total = sbQuiz.questions.length;
          const chosen = sbQuiz.selection[sbQuiz.index];
          const correctIdx = Number(q.answer_index);

          const choicesHtml = q.choices.map((c,i)=>{
            const sel = chosen === i;
            const show = sbQuiz.checked[sbQuiz.index];
            let cls = '';
            if (show && Number.isFinite(correctIdx)) {
              if (i === correctIdx) cls = 'border:1px solid #34c759;background:#eefcf2;';
              else if (i === chosen) cls = 'border:1px solid #ff3b30;background:#fff4f3;';
            }
            return `<label class="sb-q-choice" data-idx="${i}" style="display:block;margin:.4rem 0;padding:.5rem .6rem;border:1px solid #e6e6ea;border-radius:8px;cursor:pointer;${cls}">
              <input type="radio" name="sb-q" value="${i}" ${sel?'checked':''} style="margin-right:.5rem;">${sb_escapeHtml(c)}</label>`;
          }).join('');

          const feedback = sbQuiz.checked[sbQuiz.index] ? `
            <div style="margin-top:12px;padding:.6rem .75rem;border-radius:8px;background:#f7f7fb;border:1px solid #eee;">
              <div style="font-weight:600;margin-bottom:.25rem;">
                ${ Number.isFinite(correctIdx) ? (chosen === correctIdx ? '‚úÖ Correct' : '‚ùå Incorrect') : '‚ÑπÔ∏è No correct answer provided' }
              </div>
              <div class="sb-md">${sb_renderMarkdown(q.rationale || '')}</div>
            </div>` : '';

          openDrawer(`<h3>Quiz</h3>
            <div style="font-weight:600;margin-bottom:.6rem;">Q${sbQuiz.index+1}/${total}</div>
            <div style="margin:.4rem 0 1rem;font-size:1.05rem;">${sb_escapeHtml(q.question)}</div>
            ${choicesHtml}
            <div style="display:flex;gap:10px;margin-top:10px;">
              <button id="sbQuizCheck" class="sb-btn" style="width:auto;">Check</button>
              <button id="sbQuizNext" class="sb-btn" style="width:auto;" ${chosen==null?'disabled':''}>${sbQuiz.index<total-1?'Next':'Finish'}</button>
            </div>${feedback}`);

          // selection
          document.querySelectorAll('.sb-q-choice').forEach(el=>{
            el.onclick = () => {
              sbQuiz.selection[sbQuiz.index] = +el.dataset.idx;
              sb_renderQuizView();
            };
          });

          // check
          document.getElementById('sbQuizCheck').onclick = () => {
            const ch = sbQuiz.selection[sbQuiz.index];
            if (ch == null) return;
            if (!sbQuiz.checked[sbQuiz.index]) {
              if (Number.isFinite(correctIdx) && ch === correctIdx) sbQuiz.score++;
              sbQuiz.checked[sbQuiz.index] = true;
            }
            sb_renderQuizView();
          };

          // next / finish
          document.getElementById('sbQuizNext').onclick = () => {
            if (!sbQuiz.checked[sbQuiz.index]) {
              const ch = sbQuiz.selection[sbQuiz.index];
              if (ch != null && Number.isFinite(correctIdx) && ch === correctIdx) sbQuiz.score++;
              sbQuiz.checked[sbQuiz.index] = true;
            }

            if (sbQuiz.index >= total - 1) {
              const pct = Math.round((sbQuiz.score / total) * 100);
              openDrawer(`<h3>Results</h3>
                <p style="font-size:1.05rem;"><strong>Score:</strong> ${sbQuiz.score} / ${total} (${pct}%)</p>
                <div style="margin-top:10px;display:flex;gap:10px;">
                  <button id="sbQuizReview" class="sb-btn" style="width:auto;">Review</button>
                  <button id="sbQuizClose" class="sb-btn" style="width:auto;">Close</button>
                </div>`);
              document.getElementById('sbQuizClose').onclick = closeDrawer;
              document.getElementById('sbQuizReview').onclick = () => sb_renderQuizReview();
              return;
            }

            sbQuiz.index++;
            sb_renderQuizView();
          };
        }

        function sb_renderQuizReview(){
          const items = sbQuiz.questions.map((q,qi)=>{
            const ch = sbQuiz.selection[qi];
            const correct = Number(q.answer_index);
            const ok = Number.isFinite(correct) && ch === correct;
            return `<div style="border:1px solid #eee;border-radius:8px;padding:.6rem .75rem;margin:.5rem 0;">
              <div style="font-weight:600;margin-bottom:.35rem;">${ok?'‚úÖ':'‚ùå'} Q${qi+1}: ${sb_escapeHtml(q.question)}</div>
              <div><strong>Your answer:</strong> ${ch!=null?sb_escapeHtml(q.choices[ch]):'(none)'}</div>
              <div><strong>Correct:</strong> ${Number.isFinite(correct)?sb_escapeHtml(q.choices[correct]):'‚Äî'}</div>
              <div class="sb-md" style="margin-top:.4rem;">${sb_renderMarkdown(q.rationale||'')}</div>
            </div>`;
          }).join('');
          openDrawer(`<h3>Quiz Review</h3>${items}<div style="margin-top:10px;"><button id="sbQuizClose2" class="sb-btn" style="width:auto;">Close</button></div>`);
          document.getElementById('sbQuizClose2').onclick = closeDrawer;
        }

        quizBtn.addEventListener('click', requireAuthAction(async ()=>{
          openDrawer('<h3>Quiz</h3><div class="sb-code">Creating‚Ä¶</div>');
          try{
            const r = await fetch('{{ url_for("ai.quiz_json") }}', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({session_id:sessionId,subject,num_questions:5})
            });
            const d = await r.json();
            if(!r.ok || !d.questions){
              openDrawer('<h3>Quiz</h3><div class="sb-code">Failed to generate quiz.</div>');
              return;
            }
            const questions = (d.questions || []).map(sb_normQuestion);
            sbQuiz = {
              index: 0,
              score: 0,
              selection: Array(questions.length).fill(null),
              checked: Array(questions.length).fill(false),
              questions
            };
            sb_renderQuizView();
          }catch(e){
            openDrawer('<h3>Quiz</h3><div class="sb-code">Failed: '+sb_escapeHtml(e.message)+'</div>');
          }
        }));

        /* ---------------- Export ---------------- */
        exportBtn.addEventListener('click', requireAuthAction(()=>{
          const url=new URL('{{ url_for("ai.export_chat") }}',window.location.origin);
          url.searchParams.set('session_id',sessionId);
          url.searchParams.set('subject',subject);
          window.location=url.toString();
        }));

        /* ---------------- Message rendering (container untouched) ---------------- */
        function appendMessage(role, text) {
          const wrapper = document.createElement('div');
          wrapper.className = 'message ' + (role === 'user' ? 'user-message' : 'bot-message');

          const bubble = document.createElement('div');
          bubble.className = 'message-content';
          bubble.textContent = text;
          wrapper.appendChild(bubble);

          messagesEl.appendChild(wrapper);

          // After a bot message, add a separate, left-aligned tools row
          if (role === 'bot' && !IS_GUEST) {
            const tools = document.createElement('div');
            tools.className = 'message-tools';

            const verifyBtn = document.createElement('button');
            verifyBtn.className = 'icon-btn';
            verifyBtn.type = 'button';
            verifyBtn.title = 'Verify answer';
            verifyBtn.setAttribute('aria-label', 'Verify answer');
            verifyBtn.innerHTML = '‚úÖ';
            verifyBtn.addEventListener('click', () => window.verifyInfo(verifyBtn, wrapper));

            const flashBtn = document.createElement('button');
            flashBtn.className = 'icon-btn';
            flashBtn.type = 'button';
            flashBtn.title = 'Make flashcard';
            flashBtn.setAttribute('aria-label', 'Make flashcard');
            flashBtn.innerHTML = 'üìá';
            flashBtn.addEventListener('click', async () => {
              if (IS_GUEST) { showToast('Please log in to save flashcards.', 'error'); return; }
              let sel = '';
              const s = window.getSelection && window.getSelection();
              if (s && s.rangeCount > 0) sel = s.toString().trim();
              const result = await openFlashcardModal({
                front: 'Summarize the key idea',
                back: sel || text
              });
              if (!result) return;
              try {
                const res = await fetch('{{ url_for("flashcards.create_card") }}', {
                  method:'POST', headers:{'Content-Type':'application/json'},
                  body: JSON.stringify({ front: result.front, back: result.back, subject })
                });
                if (!res.ok) showToast('Failed to save flashcard', 'error');
                else showToast('‚úÖ Flashcard saved!', 'success');
              } catch(e) { showToast('Network error saving flashcard', 'error'); }
            });

            tools.append(verifyBtn, flashBtn);
            messagesEl.appendChild(tools);
          }

          messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        /* -------------- Chat: ask & reset -------------- */
        async function ask(q){
          loadingEl.style.display='block'; sendBtn.disabled=true; inputEl.disabled=true;
          try{
            const r=await fetch('/api/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:q,subject,session_id:sessionId})});
            const d=await r.json();
            if(!r.ok) appendMessage('bot', d.error || 'Error');
            else appendMessage('bot', d.answer);
          }catch(e){ appendMessage('bot','Network error: '+e.message); }
          loadingEl.style.display='none'; sendBtn.disabled=false; inputEl.disabled=false; inputEl.focus();
        }
        sendBtn.addEventListener('click',()=>{
          const q=inputEl.value.trim();if(!q)return;
          appendMessage('user',q);
          inputEl.value='';
          ask(q);
        });
        inputEl.addEventListener('keydown',e=>{
          if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendBtn.click();}
        });

        resetBtn.addEventListener('click',async()=>{
          loadingEl.style.display='block';
          await fetch('{{ url_for("ai.reset_conversation") }}',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({session_id:sessionId})});
          messagesEl.innerHTML='<div class="message bot-message"><div class="message-content">Chat reset. Ask a new question!</div></div>';
          loadingEl.style.display='none';
        });

        /* ---------------- Summary drawer ---------------- */
        summaryBtn.addEventListener('click', requireAuthAction(async () => {
          openDrawer('<h3>Summary</h3><div class="sb-code">Generating‚Ä¶</div>');
          try {
            const res = await fetch('{{ url_for("ai.summary_chat") }}', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ session_id: sessionId, subject })
            });
            let data = null, raw = '';
            try { raw = await res.text(); data = raw ? JSON.parse(raw) : {}; } catch (e) {}
            if (!res.ok) {
              const msg = (data && (data.error || data.detail)) || `HTTP ${res.status}`;
              openDrawer(`<h3>Summary</h3><div class="sb-code">Error: ${sb_escapeHtml(msg)}</div>`);
              return;
            }
            const summaryHtml = sb_renderMarkdown((data && data.summary) || '');
            const termsHtml   = sb_renderMarkdown((data && data.key_terms) || '');
            openDrawer(`<h3>Summary</h3>
              <div class="sb-md">${summaryHtml || '<p>No summary.</p>'}</div>
              ${termsHtml ? `<h4>Key terms</h4><div class="sb-md">${termsHtml}</div>` : ''}`);
          } catch (err) {
            openDrawer(`<h3>Summary</h3><div class="sb-code">Network error: ${sb_escapeHtml(err.message)}</div>`);
          }
        }));

      })();
    </script>
  </body>
</html>
