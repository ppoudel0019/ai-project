<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ subject_name }} Study Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  </head>
  <body>
    <div class="chat-container" data-subject="{{ subject }}" data-subject-name="{{ subject_name }}">
      <div class="chat-header">
        <div class="header-content">
          <a class="back-btn" onclick="window.location.href='{{ url_for('chat.subjects') }}'">&larr; Back</a>
          <h1>{{ subject_name }} Study Assistant</h1>
          <div>
            <button id="resetBtn" class="reset-btn" type="button">Reset Chat</button>
            <a class="reset-btn" href="{{ url_for('flashcards.review_queue', subject=subject) }}">Flashcards</a>
          </div>
        </div>
      </div>

      <div id="messages" class="chat-messages">
        <div class="message bot-message">
          <div class="message-content">
            Hi! I'm your {{ subject_name }} assistant. Ask me anything about {{ subject_name }}.
            I remember the last 4 Q&A pairs for context.
          </div>
        </div>
      </div>

      <div class="chat-input-container">
        <div class="chat-input-wrapper">
          <input id="questionInput" type="text" placeholder="Ask about {{ subject_name }}..." />
          <button id="sendBtn" type="button">Send</button>
        </div>
        <div id="loading" class="loading-indicator" style="display:none;">Thinking...</div>
      </div>
    </div>

<script>
  window.addEventListener('pageshow', function (e) { if (e.persisted) window.location.reload(); });
(function() {
  const container = document.querySelector('.chat-container');
  const subject = container.getAttribute('data-subject');
  const subjectName = container.getAttribute('data-subject-name');

  const messagesEl = document.getElementById('messages');
  const inputEl = document.getElementById('questionInput');
  const sendBtn = document.getElementById('sendBtn');
  const loadingEl = document.getElementById('loading');
  const resetBtn = document.getElementById('resetBtn');

  const IS_GUEST = {{ 'true' if (session.get('guest') and not current_user.is_authenticated) else 'false' }};

  let sessionId = sessionStorage.getItem('study_session_id');
  if (!sessionId) {
    sessionId = Math.random().toString(36).slice(2) + Date.now().toString(36);
    sessionStorage.setItem('study_session_id', sessionId);
  }

  function appendMessage(role, text) {
    const wrapper = document.createElement('div');
    wrapper.className = 'message ' + (role === 'user' ? 'user-message' : 'bot-message');

    const bubble = document.createElement('div');
    bubble.className = 'message-content';
    bubble.textContent = text;
    wrapper.appendChild(bubble);

    if (role === 'bot') {
      const toolsRow = document.createElement('div');
      toolsRow.className = 'message-tools';

      const verifyBtn = document.createElement('button');
      verifyBtn.type = 'button';
      verifyBtn.className = 'verify-btn';
      verifyBtn.textContent = 'Verify';
      verifyBtn.addEventListener('click', () => { window.verifyInfo(verifyBtn, wrapper); });
      toolsRow.appendChild(verifyBtn);

      const flashBtn = document.createElement('button');
      flashBtn.type = 'button';
      flashBtn.className = 'verify-btn';
      flashBtn.textContent = 'Make flashcard';
      flashBtn.addEventListener('click', async () => {
        let sel = '';
        const selection = window.getSelection && window.getSelection();
        if (selection && selection.rangeCount > 0) sel = selection.toString().trim();
        const back = sel || text;
        const front = prompt('Front (question/prompt)?', 'Summarize the key idea');
        if (!front) return;
        await saveFlashcard(front, back);
      });
      toolsRow.appendChild(flashBtn);

      wrapper.appendChild(toolsRow);
    }

    messagesEl.appendChild(wrapper);
    messagesEl.scrollTop = messagesEl.scrollHeight;
    return wrapper;
  }

  function appendSourcesUnder(wrapperEl, sourcesText) {
    const existing = wrapperEl.querySelector('.verify-sources');
    if (existing) existing.remove();
    const block = document.createElement('div');
    block.className = 'verify-sources';
    block.innerText = sourcesText || 'No sources found.';
    wrapperEl.appendChild(block);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  async function saveFlashcard(front, back) {
    if (IS_GUEST) { alert('Login to save flashcards permanently. (Guest mode cannot save.)'); return; }
    const payload = { front, back, subject };
    const res = await fetch('{{ url_for("flashcards.create_card") }}', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      alert('Failed to save flashcard: ' + (err.error || res.statusText));
    } else {
      alert('Flashcard saved!');
    }
  }

  window.ask = async function ask(question) {
    loadingEl.style.display = 'block';
    sendBtn.disabled = true; inputEl.disabled = true;
    try {
      const res = await fetch('/api/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, subject, session_id: sessionId })
      });
      const data = await res.json();
      if (!res.ok) { appendMessage('bot', data.error || 'Error generating response.'); return; }
      appendMessage('bot', data.answer);
    } catch (e) {
      appendMessage('bot', 'Network error: ' + e.message);
    } finally {
      loadingEl.style.display = 'none';
      sendBtn.disabled = false; inputEl.disabled = false; inputEl.focus();
    }
  };

  window.verifyInfo = async function verifyInfo(targetBtn, messageWrapper) {
    const prev = messageWrapper.querySelector('.verify-sources'); if (prev) prev.remove();
    const temp = document.createElement('div'); temp.className = 'verify-sources verifying'; temp.innerText = 'Verifying…';
    messageWrapper.appendChild(temp);
    if (targetBtn) { targetBtn.disabled = true; targetBtn.dataset.originalText = targetBtn.textContent; targetBtn.textContent = 'Verifying…'; }
    try {
      const res = await fetch('/api/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: sessionId, subject })
      });
      const data = await res.json();
      const reply = (data && (data.reply || data.answer)) || 'No sources found.';
      appendSourcesUnder(messageWrapper, reply);
    } catch (e) { appendSourcesUnder(messageWrapper, 'Verify failed: ' + e.message); }
    finally { if (targetBtn) { targetBtn.disabled = false; targetBtn.textContent = targetBtn.dataset.originalText || 'Verify'; } }
  };

  sendBtn.addEventListener('click', () => {
    const q = inputEl.value.trim(); if (!q) return;
    appendMessage('user', q); inputEl.value = ''; ask(q);
  });

  inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendBtn.click(); }
  });

  resetBtn.addEventListener('click', async () => {
    loadingEl.style.display = 'block';
    try {
      await fetch('{{ url_for("ai.reset_conversation") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: sessionId })
      });
      messagesEl.innerHTML = `
        <div class="message bot-message"><div class="message-content">
          Chat reset. Ask a new question about {{ subject_name }}!
        </div></div>`;
    } catch (e) { appendMessage('bot', 'Reset failed: ' + e.message); }
    finally { loadingEl.style.display = 'none'; }
  });
})();
</script>
  </body>
</html>
